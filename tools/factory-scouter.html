<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>ちょうさ・ぶんせきマシン （仮）</title>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">
var factory_data = null;
var pokemon_data = null;
var pokemon_name2id = null;
var trainer_names = null;
var natures = "がんばりや さみしがり ゆうかん いじっぱり やんちゃ ずぶとい すなお のんき わんぱく のうてんき おくびょう せっかち まじめ ようき むじゃき ひかえめ おっとり れいせい てれや うっかりや おだやか おとなしい なまいき しんちょう きまぐれ".split(" ");
var shuu_entries_count = [null, 150, 100, 100, 136, 136, 136, 192];
var shuu_entries_start = [null,   0, 150, 250, 350, 486, 622, 758];
var shuu_entries_end   = [null, 149, 249, 349, 485, 621, 757, 949];

$(function() {
	var factory_data_text;
	var pokedex_csv_text;
	var trainer_names_text;
	$.ajax({dataType: "text", url: "factory_data.txt", success: function(data) {
		factory_data_text = data;
		boot();
	}});
	$.ajax({dataType: "text", url: "pokedex.csv?20091120", success: function(data) {
		pokedex_csv_text = data;
		boot();
	}});
	$.ajax({dataType: "text", url: "trainer.txt", success: function(data) {
		trainer_names_text = data;
		boot();
	}});
	function boot() {
		if (!factory_data_text || !pokedex_csv_text || !trainer_names_text) return;
		initialize_pokemon_data(pokedex_csv_text);
		initialize_factory_entries(factory_data_text);
		initialize_trainer_names(trainer_names_text);
		$(document.forms.entries_form).submit(on_submit_entries);
		$(document.forms.seed_form).submit(on_submit_seed);

	}
});

function initialize_pokemon_data(pokedex_csv_text) {
	var lines = pokedex_csv_text.split('\n');
	if (lines[lines.length - 1] == '') lines.pop();
	var boundaries = {"♂のみ": -1, "♀のみ": 255, "1:7": 30, "1:3": 63, "1:1": 126, "3:1": 190, "ふめい": null};
	pokemon_data = new Array(lines.length);
	pokemon_name2id = {};
	for (var i = 0; i < lines.length; i ++) {
		var row = lines[i].split(',');
		var name = row[0];
		var stats = map(row.slice(1, 1 + 6), Number);
		var ability1 = row[7];
		var ability2 = row[8] || ability1;
		var gender_boundary = boundaries[row[9]];
		pokemon_name2id[name] = i;
		pokemon_data[i] = {
			id: i,
			name: name,
			stats: stats,
			abilities: [ability1, ability2],
			gender_boundary: gender_boundary
		};
	}
}

function initialize_factory_entries(factory_data_text) {
	var lines = factory_data_text.split('\n');
	if (lines[lines.length - 1] == '') lines.pop();
	factory_data = new Array(lines.length);
	for (var i = 0; i < lines.length; i ++) {
		var row = lines[i].split('|');
		factory_data[i] = {
			id: i,
			name:   row[1],
			pokemon: get_pokemon_entry(row[1]),
			nature: indexof(natures, row[2]),
			item:   row[3],
			move:   row[4],
			effort: omit_effort_text(row[5])
		};
	}
}

var silver_nejiki_id;

function initialize_trainer_names(trainer_names_text) {
	var lines = trainer_names = trainer_names_text.split('\n');
	if (lines[lines.length - 1] == '') lines.pop();
	silver_nejiki_id = lines.length;
	lines.push("ファクトリーヘッドのネジキ"); // 300を銀ネジキとして扱う
}

var context = null;
var search_timer_id = null;
var progress_div = null;

function on_submit_entries() {
	cancel_search();
	var shuu = read_shuu_input();
	if (shuu === null) return;
	var f = document.forms.entries_form;
	var r = parse_text(shuu, f.entries.value);
	if (!r) return;
	var num_bonus = FindSeedProcedure.gen_bonus_entries(shuu, r.entries).length;
	var procedure = new FindSeedProcedure(shuu, r.entries, r.parent_ids);
	(function loop() {
		var seed = procedure.run(100);
		if (seed === "timeout") {
			if (!progress_div) progress_div = build_progress_div();
			set_progress(progress_div, procedure.get_ratio());
			search_timer_id = setTimeout(loop, 0);
		} else {
			if (progress_div) remove_progress_div(progress_div);
			progress_div = null;
			search_timer_id = null;
			build_result_div(shuu, seed, 0, num_bonus, false);
		}
	})();
}

function on_submit_seed() {
	cancel_search();
	var shuu = read_shuu_input();
	if (shuu === null) return;
	var f = document.forms.seed_form;
	var seed = read_int_string(f.seed.value);
	var consumption = read_int_string(f.consumption.value, 0);
	var num_bonus = read_int_string(f.num_bonus.value, 0);
	if (seed === null) {
		alert("seedに入力されている値が不正です");
		return;
	}
	if (consumption === null) {
		alert("消費量に入力されている値が不正です");
		return;
	}
	if (num_bonus === null || num_bonus < 0 || num_bonus > 6) {
		alert("ボーナスポケモンの数に入力されている値が不正です");
		return;
	}
	seed = step_seed(seed, consumption);
	build_result_div(shuu, seed, consumption, num_bonus, true);
}

function cancel_search() {
	clearTimeout(search_timer_id);
	if (progress_div) remove_progress_div(progress_div);
	progress_div = null;
}

function read_shuu_input() {
	var value = read_int_string(document.getElementById("shuu_input").value);
	if (value === null || value < 1 || value > 3) {
		alert("周に入力されている値が不正です");
		return null;
	}
	return value;
}

var progress_width = 100;

function build_progress_div() {
	var p = document.forms.entries_form.entries_submit.parentNode;
	var div = document.createElement("div");
	div.className = "progress";
	div.style.width = (progress_width + 2) + "px";
	var bar = document.createElement("div");
	bar.className = "progress_bar";
	div.appendChild(bar);
	p.appendChild(div);
	return div;
}

function set_progress(div, ratio) {
	div.firstChild.style.width = Math.floor(ratio * progress_width) + "px";
}

function remove_progress_div(div) {
	div.parentNode.removeChild(div);
}

function build_result_div(shuu, seed, consumption, num_bonus, input_by_seed) {
	var div = document.getElementById("result");
	if (seed === null) {
		div.innerHTML = "<p>その組み合わせのseedが見つかりません</p>";
		return;
	}
	var r = get_6_entries_info(shuu, seed, consumption, num_bonus);
	var entries = r.entries;
	var seed_head = seed;
	var consumption_head = consumption;
	seed = r.seed;
	consumption = r.next_consumption;
	var entries_in_hand = entries.slice(0, 3);
	var trainers_candidate = get_trainers_candidate(seed_head, shuu);
	var trainers = trainers_candidate[0];
	var trainer_ids = trainers.trainer_ids;
	context = {shuu: shuu,
	           infos: [r],
	           trainers: trainers_candidate,
	           selected_trainers_index: 0};
	
	var buf = [];
	buf.push("<p>6匹決定時のseed: "+format_hex(seed_head, 8));
	var seeds = get_entries_back_seeds(shuu, seed_head, num_bonus);
	if (!input_by_seed && seeds.length > 0) {
		buf.push(" (or "+map(seeds, function(i){return format_hex(i, 8)}).join(", ")+")");
	}
	buf.push("</p>");
	buf.push("<p>最初の6匹 ");
	buf.push("<span id=\"range-0\" class=\"range\">"+r.rand_range.first+"-"+r.rand_range.last+"</span>");
	buf.push(" <button id=\"paste-to-textarea\">この6匹を上のテキストボックスに入力</button>");
	buf.push(" <button class=\"show-tooltip\" id=\"show-tooltip-0\">6匹決定の乱数列</button>");
	buf.push("</p>");
	buf.push("<div class=\"entries\" id=\"entries-0\">");
	build_table(buf, r.infos, 0);
	buf.push("</div>");
	buf.push("<p id=\"election\">選出: "+build_select(entries, 0)+" "+build_select(entries, 1)+" "+build_select(entries, 2)+"</p>");
	buf.push("<p>トレーナー: <select id=\"trainers\">"+build_trainers_options(trainers_candidate, consumption_head)+"</select><br>");
	buf.push("<small>トレーナーの種類は相手が何周目のポケモンを使ってくるかに影響します</small></p>");
	for (var i = 1; i <= 7; i ++) {
		var visited_entries;
		if (i === 1) {
			visited_entries = entries;
		} else {
			visited_entries = entries_in_hand.concat(prev_enemy_entries);
		}
		var trainer_id = trainer_ids[i-1];
		var enemy_shuu = trainer_id_to_shuu(trainer_id);
		var r = get_3_entries_info(enemy_shuu, seed, consumption, visited_entries, entries_in_hand);
		context.infos.push(r);
		if (i > 1) {
			buf.push("<p class=\"exchange\">交換: <select id=\"exchange-part-"+(i-1)+"\"><option></option>"+build_options(entries_in_hand)+"</select>");
			buf.push("→ <select id=\"exchange-receive-"+(i-1)+"\"><option></option>"+build_options(prev_enemy_entries)+"</select>");
			buf.push(" (手持ち: <span id=\"entries-in-hand-"+i+"\">"+map(entries_in_hand, "name").join(" ")+"</span>)</p>");
		}
		buf.push("<p>"+i+"戦目 <span id=\"trainer-name-"+i+"\">"+trainer_names[trainer_id]+"</span>");
		buf.push(" <span id=\"range-"+i+"\" class=\"range\">"+r.rand_range.first+"-"+r.rand_range.last+"</span>");
		buf.push(" <button class=\"show-tooltip\" id=\"show-tooltip-"+i+"\">3匹決定の乱数列</button>");
		buf.push("</p>");
		buf.push("<div class=\"entries\" id=\"entries-"+i+"\">");
		build_table(buf, r.infos, i);
		buf.push("</div>");
		var c = get_enemy_consuption(shuu, i, enemy_shuu);
		seed = step_seed(r.seed, c);
		consumption = r.next_consumption + c;
		prev_enemy_entries = r.entries;
	}
	div.innerHTML = buf.join("");
	$("#election select").change(on_select_change).keypress(on_select_change);
	$("#result > p.exchange select").change(on_exchange_select_change).keypress(on_exchange_select_change);
	$("#paste-to-textarea").click(paste_to_textarea);
	$("#trainers").change(on_trainers_select_change).keypress(on_trainers_select_change);
	$("#result > div.entries > table > tbody > tr").mouseenter(on_mouseenter_tr).mouseleave(on_mouseleave_tr);
	$("button.show-tooltip").mouseenter(show_tooltip).mouseleave(hide_tooltip);
}

function get_selected_trainer_ids() {
	return context.trainers[context.selected_trainers_index].trainer_ids;
}

function get_trainers_candidate(seed_head, shuu) {
	var i = 14;
	var seed = step_seed(seed_head, -i);
	var result = [];
	while (i < 50) {
		var r = get_trainers_by_seed(shuu, seed);
		if (7 <= i - r.c && i - r.c <= 12) {
			result.push({start: -i, c: r.c, trainer_ids: r.trainer_ids});
		}
		i ++;
		seed = prev_seed(seed);
	}
	return result;
}

function build_trainers_options(trainers_canndidate, consumption) {
	var buf = "";
	for (var i = 0; i < trainers_canndidate.length; i ++) {
		var e = trainers_canndidate[i];
		buf += "<option>"+(e.start+consumption)+".."+(e.start+e.c+consumption)+": "+map(e.trainer_ids, trainer_id_to_name).join(", ")+"</option>";
	}
	return buf;
}

// 相手の3匹決定後の乱数消費量を取得
function get_enemy_consuption(shuu, nth, enemy_shuu) {
	var c = 0;
	if (nth === 1) {
		switch(shuu) {
		case 1: c = 18; break;
		case 2: c = 36; break;
		case 3: c = 36; break;
		default: throw new Error;
		}
	}
	switch(enemy_shuu) {
	case 1: c +=  6; break;
	case 2: c += 12; break;
	case 3: c += 12; break;
	case 4: c +=  0; break; // XXX
	default: throw new Error;
	}
	return c;
}

function trainer_id_to_name(i) {
	return /の([^の]+)$/.exec(trainer_names[i])[1];
}

function get_entries_back_seeds(shuu, seed, num_bonus) {
	var first_shuu = num_bonus === 6 ? shuu + 1 : shuu;
	var e = seed_to_entry(first_shuu, seed);
	var result = [];
	while (true) {
		seed = prev_seed(seed);
		var prev_e = seed_to_entry(first_shuu, seed);
		if (e !== prev_e) break;
		result.push(seed);
	}
	return result;
}

function read_int_string(s, default_value) {
	if (/^\s*$/.test(s) && default_value !== undefined) {
		return default_value;
	}
	if (!/^\s*(?:-?\d+|0x[0-9a-f]+)\s*$/i.test(s)) {
		return null;
	}
	return Number(s);
}

function parse_text(shuu, text) {
	var lines = regularize_word(text).split("\n");
	var entries = [];
	var parent_ids = [];
	for (var i = 0; i < lines.length; i ++) {
		var line = lines[i];
		if (/^\s*$/.test(line)) continue;
		var m = /^\s*(\S+)\s+(\d+)((?:\s+b)?)\s*$/.exec(line);
		if (!m) {
			alert((i+1)+"行目が不正です\n> "+line);
			return null;
		}
		var name = m[1], parent_id = Number(m[2]), is_bonus = m[3] !== "";
		if (entries.length == 6) {
			alert("6匹より多く入力されています");
			return null;
		}
		var entry;
		if (is_bonus) {
			entry = find_factory_entry(shuu + 1, name);
		} else {
			entry = find_factory_entry(shuu, name);
			if(!entry && shuu > 1) entry = find_factory_entry(shuu + 1, name);
		}
		if (!entry) {
			alert((i+1)+"行目: \""+name+"\"は存在しません");
			return null;
		}
		if (parent_id < 0 || parent_id >= 65536) {
			alert((i+1)+"行目: "+parent_id+"は不正なIDです");
			return null;
		}
		if (ary_include(entries, entry)) {
			alert((i+1)+"行目: "+entry.name+"が重複しています");
			return null;
		}
		if (entries_collision0(entry, entries)) {
			alert((i+1)+"行目: "+entry.name+"はアイテムが重複しています");
			return null;
		}
		entries.push(entry);
		parent_ids.push(parent_id);
	}
	if (entries.length != 6) {
		alert("6匹入力されていません");
		return null;
	}
	return {entries: entries, parent_ids: parent_ids};
}

function entry_id_to_shuu(id) {
	if (id < 150) return 1;
	if (id < 250) return 2;
	if (id < 350) return 3;
	if (id < 486) return 4;
	if (id < 622) return 5;
	if (id < 758) return 6;
	return 7;
}

function on_select_change() {
	var shuu = context.shuu;
	var six_entries = context.infos[0].entries;
	var selects = $("#election select");
	var entries_in_hand = [];
	for (var i = 0; i < 3; i ++) {
		var select = selects[i];
		var entry = six_entries[select.selectedIndex];
		entries_in_hand.push(entry);
	}
	if (!ary_eq(context.infos[1].entries_in_hand, entries_in_hand)) {
		context.infos[1].entries_in_hand = entries_in_hand;
		change_enemy_entries(2);
	}
}

function on_exchange_select_change() {
	var n = Number(/^exchange-(?:part|receive)-(\d)/.exec(this.id)[1]);
	var part = document.getElementById("exchange-part-"+n).selectedIndex - 1;
	var receive = document.getElementById("exchange-receive-"+n).selectedIndex - 1;
	var entries_in_hand = context.infos[n].entries_in_hand.slice();
	var enemy_entries = context.infos[n].entries;
	if (part !== -1 && receive !== -1) {
		entries_in_hand[part] = enemy_entries[receive];
	}
	if (!ary_eq(context.infos[n + 1].entries_in_hand, entries_in_hand)) {
		context.infos[n + 1].entries_in_hand = entries_in_hand;
		change_entries_in_hand_text(n + 1);
		// n戦目後に交換してもn+1戦目の3匹は変わらない。n+2戦目以降の3匹が変わる。
		if (n + 2 <= 7) {
			change_enemy_entries(n + 2);
		}
	}
}

function on_trainers_select_change() {
	context.selected_trainers_index = this.selectedIndex;
	var trainer_ids = context.trainers[this.selectedIndex].trainer_ids;
	for (var i = 1; i <= 7; i ++) {
		$("#trainer-name-"+i).text(trainer_names[trainer_ids[i-1]]);
	}
	change_enemy_entries(1);
}

function change_enemy_entries(start) {
	var prev_enemy_entries = start > 1 ? context.infos[start - 1].entries : null;
	var shuu = context.shuu;
	var seed = context.infos[start].seed_start;
	var consumption = context.infos[start].rand_range.first;
	var trainer_ids = get_selected_trainer_ids();
	var entries_in_hand = context.infos[start > 1 ? start - 1 : 1].entries_in_hand;
	for (var i = start; i <= 7; i ++) {
		var visited_entries = i === 1 ? context.infos[0].entries : entries_in_hand.concat(prev_enemy_entries);
		var enemy_shuu = trainer_id_to_shuu(trainer_ids[i-1]);
		var r = get_3_entries_info(enemy_shuu, seed, consumption, visited_entries, entries_in_hand);
		context.infos[i] = r;
		
		if (i > 1) {
			$("#exchange-part-"+(i-1)).html("<option></option>"+build_options(entries_in_hand));
			$("#exchange-receive-"+(i-1)).html("<option></option>"+build_options(prev_enemy_entries));
			change_entries_in_hand_text(i);
		}
		
		$("#range-"+i).text(r.rand_range.first+"-"+r.rand_range.last);
		
		var div = document.getElementById("entries-"+i);
		var buf = [];
		build_table(buf, r.infos, i)
		div.innerHTML = buf.join("");
		$("> table > tbody > tr", div).mouseenter(on_mouseenter_tr).mouseleave(on_mouseleave_tr);
		var c = get_enemy_consuption(shuu, i, enemy_shuu);
		seed = step_seed(r.seed, c);
		consumption = r.next_consumption + c;
		prev_enemy_entries = r.entries;
	}
}

function change_entries_in_hand_text(i) {
	$("#entries-in-hand-"+i).text(map(context.infos[i].entries_in_hand, "name").join(" "));
}

function build_select(entries, selectedIndex) {
	return "<select>" + build_options(entries, selectedIndex) + "</select>";
}

function build_options(entries, selectedIndex) {
	var buf = "";
	for (var i = 0; i < entries.length; i ++) {
		buf += "<option"+(selectedIndex===i ? " selected " : "")+">"+entries[i].name+"</option>";
	}
	return buf;
}

function build_table(buf, info, nth) {
	buf.push("<table><thead><tr><th>周<th>No<th>名前<th>アイテム<th>特性<th>性別<th>ID<th>裏ID<th>性格値</tr></thead>");
	buf.push("<tbody>");
	for (var i = 0; i < info.length; i ++) {
		var e = info[i];
		var pid = e.pid;
		var entry = e.entry;
		buf.push("<tr id=\"entry-"+nth+"-"+i+"\">"+
		         "<td>"+entry_id_to_shuu(entry.id)+
		         "<td>"+(entry.id+1)+
		         "<td>"+entry.name+
		         "<td>"+entry.item+
		         "<td>"+entry.pokemon.abilities[pid % 2]+
		         "<td>"+pid2gender(pid, entry.pokemon)+
		         "<td>"+format_dec(e.parent_id, 5)+
		         "<td>"+format_dec(e.secret_id, 5)+
		         "<td>"+format_hex(pid, 8)+"</tr>");
	}
	buf.push("</tbody></table>");
}

function paste_to_textarea() {
	var shuu = context.shuu;
	var infos = context.infos[0].infos;
	var buf = "";
	for (var i = 0; i < 6; i ++) {
		if (i > 0) buf += "\n";
		buf += infos[i].entry.name + " " + infos[i].parent_id;
		if (entry_id_to_shuu(infos[i].entry.id) === shuu + 1) {
			buf += " b";
		}
	}
	document.forms.entries_form.entries.value = buf;
	document.getElementById("shuu_input").value = shuu;
}

function show_tooltip() {
	var button = this;
	var n = /^show-tooltip-(\d)$/.exec(button.id)[1];
	var tooltip = document.getElementById("tooltip-"+n);
	if (tooltip) {
		$(tooltip).html(get_tooltip_content(n));
		tooltip.style.display = "";
		resize_tooltip(button, tooltip);
		return;
	}
	tooltip = $("<div id=\"tooltip-"+n+"\" class=\"tooltip\"></div>")
	           .html(get_tooltip_content(n))[0];
	$("#result").append(tooltip);
	resize_tooltip(button, tooltip);
	$(window).resize(function() {
		resize_tooltip(button, tooltip);
	});
	$(tooltip).mouseleave(function(ev) {
		if (ev.relatedTarget !== button) {
			tooltip.style.display = "none";
		}
	});
}

function get_tooltip_content(nth) {
	var info = context.infos[nth];
	var shuu = info.shuu;
	var seed = info.seed_start;
	var consumption = info.rand_range.first;
	var n = info.entries.length;
	var visited_entries = info.visited_entries;
	var num_bonus = info.num_bonus;
	var i = 0;
	var entries = [];
	var r = [];
	while (i < n) {
		var is_bonus = n - i <= num_bonus;
		var entry_shuu = is_bonus ? shuu + 1 : shuu;
		var count = shuu_entries_count[entry_shuu];
		var start = shuu_entries_start[entry_shuu];
		var id = count - 1 - (seed >>> 16) % count + start;
		var entry = factory_data[id];
		var collided_entry = find_collided_entry(entry, entries, visited_entries);
		
		r.push({seed: seed, count: count, start: start, id: id, entry: entry, collided_entry: collided_entry});
		seed = next_seed(seed);
		if (collided_entry) continue;
		entries.push(entry);
		i ++;
	}
	var buf = "<pre>";
	var prec = Math.max(String(consumption).length, String(consumption + r.length - 1).length);
	for (var i = 0; i < r.length; i ++) {
		var e = r[i];
		if (i >= 0) buf += "\n";
		if (e.collided_entry) buf += "<span class=\"collided\">";
		buf += format_dec(consumption + i, prec, " ") + " (" + format_hex(e.seed, 8) + "): " +
		       format_dec(e.count, 3, " ") + " - " + format_hex(e.seed >>> 16, 4) + " % " + 
		       format_dec(e.count, 3, " ") + " + " + format_dec(e.start, 3, " ") + " = " + 
		       format_dec(e.id + 1, 3, " ") + " " + rjust_name(e.entry.name) + " (" + e.entry.item + ")";
		if (e.collided_entry) buf += "</span>";
	}
	buf += "</pre>"
	return buf;
}

function resize_tooltip(button, tooltip) {
	var width = tooltip.offsetWidth;
	var height = tooltip.offsetHeight;
	var offset = $(button).offset();
	var scrollTop  = document.body.scrollTop  || document.documentElement.scrollTop;
	// ボタンの上に表示するスペースがなければボタンの下に表示
	if (offset.top - height >= scrollTop) {
		tooltip.style.top = (offset.top - height) + "px";
	} else {
		tooltip.style.top = (offset.top + button.offsetHeight) + "px";
	}
	tooltip.style.left = Math.max(offset.left + button.offsetWidth + 20 - width, 4) + "px";
}

function hide_tooltip(ev) {
	var button = this;
	var n = /^show-tooltip-(\d)$/.exec(button.id)[1];
	var tooltip = document.getElementById("tooltip-"+n);
	if (!tooltip) return;
	if (ev.relatedTarget === tooltip) return;
	tooltip.style.display = "none";
}

function on_mouseenter_tr(ev) {
	var tr = this;
	if (tr.className === "entry-detail") return;
	if (tr.nextSibling && tr.nextSibling.className === "entry-detail") {
		if (tr.nextSibling.style.display === "none") {
			tr.nextSibling.style.display = "";
			set_tr_rowspan(tr, 2);
		}
		return;
	}
	var detail_tr = $("<tr class=\"entry-detail\"></tr>").html("<td colspan=\"6\">"+build_entry_detail(tr)+"</td>");
	detail_tr.mouseleave(on_mouseleave_detail_tr);
	$(tr).after(detail_tr);
	set_tr_rowspan(tr, 2);
}

function set_tr_rowspan(tr, n) {
	for (var i = 0; i < 3; i ++) {
		tr.childNodes[i].setAttribute("rowSpan", n);
	}
}

function on_mouseleave_tr(ev) {
	var tr = this;
	if (tr.parentNode.tagName.toUpperCase() !== "TBODY") return;
	if (tr.nextSibling && tr.nextSibling.className === "entry-detail") {
		if (!elementWithIn(tr.nextSibling, ev.relatedTarget)) {
			remove_detail_tr(tr);
		}
	}
}

function remove_detail_tr(tr) {
	tr.nextSibling.style.display = "none";
	set_tr_rowspan(tr, 1);
}

function on_mouseleave_detail_tr(ev) {
	var tr = this.previousSibling;
	if (!elementWithIn(tr, ev.relatedTarget)) {
		remove_detail_tr(tr);
	}
}

var Lv50 = 50; // あとあとソースからLv50で検索してひっかかるように

function build_entry_detail(tr) {
	var m = /^entry-(\d)-(\d)$/.exec(tr.id);
	var i = Number(m[1]);
	var j = Number(m[2]);
	var entry = context.infos[i].entries[j];
	var shuu = entry_id_to_shuu(entry.id);
	var individual = get_individual_by_shuu(shuu);
	var buf = "<small>";
	buf += "性格: "+natures[entry.nature]+" 努力値: "+entry.effort+" 個体値: "+individual+"<br>";
	buf += "技: "+entry.move+"<br>";
	buf += "ステータス: "+get_status(Lv50, entry, individual).join("-");
	buf += "</small>"
	return buf;
}

function get_individual_by_shuu(shuu) {
	if (shuu >= 8) return 31;
	return (shuu - 1) * 4;
}

var nature_table = new Array(25);
(function() {
	var fix = [0, 1, 4, 2, 3]; // HABSCD順をHABCDS順に
	for (var i = 0; i < 25; i ++) {
		var row = [10, 10, 10, 10, 10];
		row[fix[i / 5 | 0]] ++;
		row[fix[i % 5]] --;
		nature_table[i] = row;
	}
})();

var status_names = 'HP,攻撃,防御,特攻,特防,すば'.split(',');

function omit_effort_text(text) {
	// ex. omit_effort_text("HP/攻撃")
	//  => "HA"
	var list = text.split("/");
	var result = "";
	for(var i = 0; i < list.length; i ++) {
		result += "HABCDS".charAt(indexof(status_names, list[i]));
	}
	return result;
}

function effort_text_to_array(text) {
	// ex. effort_text_to_array("HA")
	//  => [255, 255, 0, 0, 0, 0]
	var t = "HABCDS";
	var efforts = [0, 0, 0, 0, 0, 0];
	for(var i = 0; i < text.length; i ++) {
		efforts[t.indexOf(text.charAt(i))] = text.length === 3 ? 170 : 255;
	}
	return efforts;
}

function get_status(lv, entry, individual) {
	// ex. get_status(50, find_factory_entry(1, "フシギダネ"), 0)
	// => [105, 48, 54, 111, 101, 50]
	var stats = entry.pokemon.stats;
	var efforts = effort_text_to_array(entry.effort);
	var hp = calc_status_hp(lv, stats[0], individual, efforts[0]);
	if (stats[0] === 1) hp = 1; // ヌケニン
	var result = [hp];
	var nature_revisions = nature_table[entry.nature];
	for (var i = 0; i < 5; i ++) {
		result.push(calc_status(lv, stats[i + 1], individual, efforts[i + 1], nature_revisions[i]));
	}
	return result;
}

function calc_status_hp(lv, base, individual, effort) {
	return Math.floor((base * 2 + Math.floor(effort / 4) + individual) * lv / 100) + lv + 10;
}

function calc_status(lv, base, individual, effort, nature_revision) {
	return Math.floor((Math.floor((base * 2 + Math.floor(effort / 4) + individual) * lv / 100) + 5) * nature_revision / 10);
}

function get_pokemon_entry(name) {
	return pokemon_data[pokemon_name2id[name]];
}

function pid2gender(pid, pokemon) {
	var boundary = pokemon.gender_boundary;
	if (boundary !== null) {
		return (pid & 0xff) > boundary ? "♂" : "♀";
	} else {
		return "不明";
	}
}

function get_trainers_by_seed(shuu, seed) {
	var result = [];
	var c = 0;
	var i = 1;
	while (i <= 7) {
		if (shuu === 3 && i === 7) {
			result.push(silver_nejiki_id);
			break;
		}
		var e = seed_to_trainer_id(shuu, i, seed);
		seed = next_seed(seed);
		c ++;
		if (ary_include(result, e)) continue;
		result.push(e);
		i ++;
	}
	return {trainer_ids: result, c: c};
}

function seed_to_trainer_id(shuu, nth, seed) {
	var r = seed >>> 16;
	if (nth === 7) {
		switch (shuu) {
		case 1: return r % 19 + 100;
		case 2: return r % 19 + 120;
		}
	} else {
		switch (shuu) {
		case 1: return r % 99 +   0;
		case 2: return r % 39 +  80;
		case 3: return r % 39 + 100;
		}
	}
	throw new Error;
}

function trainer_id_to_shuu(id) {
	if (id < 0) throw new Error;
	if (id <= 99) return 1;
	if (id <= 119) return 2;
	if (id <= 139) return 3;
	if (id === silver_nejiki_id) return 4;
	throw new Error;
}

function seed_to_entry_id(shuu, seed) {
	var count = shuu_entries_count[shuu];
	var start = shuu_entries_start[shuu];
	return count - 1 - (seed >>> 16) % count + start;
}

function seed_to_entry(shuu, seed) {
	return factory_data[seed_to_entry_id(shuu, seed)];
}

function get_3_entries_info(shuu, seed, consumption, visited_entries, entries_in_hand) {
	return get_entries_info(shuu, seed, consumption, 3, visited_entries, entries_in_hand, 0);
}

function get_6_entries_info(shuu, seed, consumption, num_bonus) {
	return get_entries_info(shuu, seed, consumption, 6, [], null, num_bonus);
}

function get_entries_info(shuu, seed, consumption, num, visited_entries, entries_in_hand, num_bonus) {
	var entries = [];
	var infos = [];
	var i = 0;
	var seed_start = seed;
	var c = consumption;
	while (i < num) {
		var is_bonus = num - i <= num_bonus;
		var entry = seed_to_entry(is_bonus ? shuu + 1 : shuu, seed);
		seed = next_seed(seed); c ++;
		if (entries_collision(entry, entries, visited_entries)) continue;
		entries.push(entry);
		i ++;
	}
	
	for (var i = 0; i < num; i ++) {
		var parent_id = seed >>> 16;
		seed = next_seed(seed); c ++;
		var secret_id = seed >>> 16;
		seed = next_seed(seed); c ++;
		var nature = entries[i].nature;
		do {
			var pid_row = seed >>> 16;
			seed = next_seed(seed); c ++;
			var pid_high = seed >>> 16;
			seed = next_seed(seed); c ++;
			var pid = (pid_high << 16 | pid_row) >>> 0;
		} while (pid % 25 != nature || is_shiny_pid(parent_id, secret_id, pid));
		infos.push({entry: entries[i],
		            parent_id: parent_id,
		            secret_id: secret_id,
		            pid: pid});
	}
	
	var range = {first: consumption, last: c - 1};
	
	if (num === 6) {
		var swap1 = (seed >>> 16) % 6;
		seed = next_seed(seed); c ++;
		var swap2 = (seed >>> 16) % 6;
		seed = next_seed(seed); c ++;
		
		ary_swap(infos, 4, swap1);
		ary_swap(infos, 5, swap2);
		
		ary_swap(entries, 4, swap1);
		ary_swap(entries, 5, swap2);
	}
	
	return {entries: entries,
	        infos: infos,
	        seed: seed,
	        seed_start: seed_start,
	        rand_range: range,
	        next_consumption: c,
	        entries_in_hand: entries_in_hand,
	        visited_entries: visited_entries,
	        num_bonus: num_bonus,
	        shuu: shuu};
}

function entries_collision(entry, entries, visited_entries) {
	return entries_collision0(entry, entries) || entries_collision0(entry, visited_entries);
}

function entries_collision0(entry, entries) {
	for (var i = 0; i < entries.length; i ++) {
		if (entry === entries[i]) return true;
		if (entry.item === entries[i].item) return true;
	}
	return false;
}

function find_collided_entry(entry, entries, visited_entries) {
	return find_collided_entry0(entry, entries) || find_collided_entry0(entry, visited_entries);
}

function find_collided_entry0(entry, entries) {
	for (var i = 0; i < entries.length; i ++) {
		if (entry === entries[i]) return entry;
		if (entry.item === entries[i].item) return entry;
	}
	return null;
}

function FindSeedProcedure(shuu, entries, parent_ids) {
	this.shuu = shuu;
	this.entries = entries;
	this.parent_ids = parent_ids;
	this.items = FindSeedProcedure.gen_items(entries);
	this.bonus_entries = FindSeedProcedure.gen_bonus_entries(shuu, entries);
	if (this.bonus_entries.length == 6) {
		this.bonus_entries = [];
		this.shuu += 1;
	}
	this.num_bonus = this.bonus_entries.length;
	this.last_candidate_entries = this.num_bonus > 0 ? this.bonus_entries : this.entries;
	this.last_entry_shuu = this.num_bonus > 0 ? this.shuu + 1 : this.shuu;
	this.ns = FindSeedProcedure.gen_ns(this.shuu, entries);
	this.i = 0;
	this.j = 0;
}

FindSeedProcedure.gen_items = function(entries) {
	var result = [];
	for (var i = 0; i < entries.length; i ++) {
		result.push(entries[i].item);
	}
	return result;
};

FindSeedProcedure.gen_bonus_entries = function(shuu, entries) {
	var start = shuu_entries_start[shuu + 1];
	var result = [];
	for (var i = 0; i < 6; i ++) {
		var entry = entries[i];
		if (entry.id >= start) result.push(entry);
	}
	return result;
};

FindSeedProcedure.gen_ns = function(shuu, entries) {
	var start = shuu_entries_start[shuu + 1];
	var _ns = [0, 4, 5];
	var ns = [];
	for (var i = 0; i < 3; i ++) {
		var n = _ns[i];
		// ボーナスポケモンは先頭になるはずがないので除外
		if (entries[n].id < start) {
			ns.push(n);
		}
	}
	return ns;
};

FindSeedProcedure.prototype.run = function(timeout) {
	var start_time = + new Date;
	var start_i = this.i;
	for (; this.i < this.ns.length; this.i ++) {
		var n = this.ns[this.i];
		var entry = this.entries[n];
		var parent_id = this.parent_ids[n];
		var j = this.i === start_i ? this.j : 0;
		for (; j < 65536; j ++) {
			var seed = (parent_id << 16 | j) >>> 0;
			seed_head = this.match_entries(seed, entry);
			if (seed_head !== null) return seed_head;
			if ((j & 255) === 0 && new Date - start_time >= timeout) {
				this.j = j + 1;
				return "timeout";
			}
		}
	}
	return null;
};

FindSeedProcedure.prototype.get_ratio = function() {
	return (this.i * 65536 + this.j) / (this.ns.length * 65536);
}

FindSeedProcedure.prototype.match_entries = function(seed, first_entry) {
	var last_entry = seed_to_entry(this.last_entry_shuu, prev_seed(seed));
	if (!ary_include(this.last_candidate_entries, last_entry)) return null;
	var n = 6;
	var seed_head = step_seed(seed, -n);
	// 乱数列が A,B,C,D,E,A,F のとき raw_entries は B,C,D,E,A,F になるので先頭要素が一致しなくなる
	// 先頭要素が一致しない場合はさらに前の乱数列をさかのぼってみる。
	for (;;seed_head=prev_seed(seed_head),n++) {
		var s = seed;
		var raw_entries = this.find_entries(seed_head, n);
		if (raw_entries === "break") break;
		if (raw_entries === "next") continue;
		if (raw_entries[0] !== first_entry) {
			// 先頭要素が一致しない
			continue;
		}
		var s = this.match_parent_ids(seed, raw_entries);
		if (s === null) continue;
		var swap1 = (s >>> 16) % 6;
		s= next_seed(s);
		var swap2 = (s >>> 16) % 6;
		if (!this.match_swap(raw_entries, swap1, swap2)) continue;
		return seed_head;
	}
	return null;
};

FindSeedProcedure.prototype.find_entries = function(seed, n) {
	var shuu = this.shuu;
	var raw_entries = [];
	var steps = 0;
	var i = 0, num = 6 - this.num_bonus;
	while (i < 6) {
		var is_bonus = 6 - i <= this.num_bonus;
		var s = seed;
		var entry = seed_to_entry(is_bonus ? shuu + 1 : shuu, seed);
		seed = next_seed(seed);
		steps ++;
		if (steps > n) return "next";
		if (entries_collision0(entry, raw_entries)) continue;
		// アイテムも一致しないエントリが存在した場合
		if (!ary_include(this.items, entry.item)) {
			// ボーナスポケモン決定時でアイテム重複でスキップされたエントリかもしれない
			var item = seed_to_entry(shuu + 1, s).item;
			if (this.num_bonus > 0 && !is_bonus && ary_include(this.items, item)) {
				return "next";
			} else {
				return "break";
			}
		}
		raw_entries.push(entry);
		i ++;
	}
	if (steps !== n) return "next";
	for (var i = 0; i < 6; i ++) {
		if(!ary_include(this.entries, raw_entries[i])) {
			return "next";
		}
	}
	return raw_entries;
};

FindSeedProcedure.prototype.match_swap = function(raw_entries, swap1, swap2) {
	raw_entries = raw_entries.slice();
	ary_swap(raw_entries, 4, swap1);
	ary_swap(raw_entries, 5, swap2);
	return ary_eq(this.entries, raw_entries);
};

FindSeedProcedure.prototype.match_parent_ids = function (seed, raw_entries) {
	for (var i = 0; i < 6; i ++) {
		var entry = raw_entries[i];
		var expected_parent_id = this.parent_ids[indexof(this.entries, entry)];
		var parent_id = seed >>> 16;
		seed = next_seed(seed);
		if (parent_id !== expected_parent_id) return null;
		var secret_id = seed >>> 16;
		seed = next_seed(seed);
		var nature = entry.nature;
		do {
			var pid_row = seed >>> 16;
			seed = next_seed(seed);
			var pid_high = seed >>> 16;
			seed = next_seed(seed);
			var pid = (pid_high << 16 | pid_row) >>> 0;
		} while (pid % 25 != nature || is_shiny_pid(parent_id, secret_id, pid));
	}
	return seed;
};

function is_shiny_pid(parent_id, secret_id, pid) {
	return ((parent_id ^ secret_id ^ (pid >>> 16) ^ (pid & 0xffff)) & ~7) == 0;
}

function find_factory_entry(shuu, name) {
	var re = roma2reg(name);
	var start = shuu_entries_start[shuu];
	var end = shuu_entries_end[shuu];
	for (var i = start; i <= end; i ++) {
		if (re.test(factory_data[i].name)) {
			return factory_data[i];
		}
	}
	return null;
}

function roma2reg(text) {
	var result = [];
	var len = 0;
	for (var i = 0; i < text.length; i += len) {
		len = 1;
		var t = text.charAt(i)
		if (!/[a-z-]/.test(t)) {
			result.push(regexp_escape(t));
			continue;
		}
		var token = roma2reg_search_token(text, i);
		if (!token) {
			result.push(t);
			continue;
		}
		var kana = roma2reg.kana_map[token];
		if (token.length == 2 && kana == "ッ") {
			result.push("(?:" + token.charAt(0) + "|" + kana + ")");
		} else {
			result.push("(?:" + token + "|" + kana + ")");
			len = token.length;
		}
	}
	return new RegExp("^"+result.join("")+"$", "i");
}

function regexp_escape(s) {
	return s.replace(/\W/g,'\\$&');
}

function roma2reg_search_token(text, i) {
	for (var n = 4; n >= 1; n --) {
		var token = text.substr(i, n);
		if (roma2reg.kana_map.hasOwnProperty(token)) {
			return token;
		}
	}
	return null;
}

roma2reg.kana_map = {"a":"ア","i":"イ","yi":"イ","u":"ウ","wu":"ウ","whu":"ウ","e":"エ","o":"オ","la":"ァ","xa":"ァ","li":"ィ","xi":"ィ","lyi":"ィ","xyi":"ィ","lu":"ゥ","xu":"ゥ","le":"ェ","xe":"ェ","lye":"ェ","xye":"ェ","lo":"ォ","xo":"ォ","wha":"ウァ","whi":"ウィ","wi":"ウィ","whe":"ウェ","we":"ウェ","who":"ウォ","ka":"カ","ca":"カ","ki":"キ","ku":"ク","cu":"ク","qu":"ク","ke":"ケ","ko":"コ","co":"コ","lka":"ヵ","xka":"ヵ","lke":"ヶ","xke":"ヶ","ga":"ガ","gi":"ギ","gu":"グ","ge":"ゲ","go":"ゴ","kya":"キャ","kyi":"キィ","kyu":"キュ","kye":"キェ","kyo":"キョ","qya":"クャ","qyu":"クュ","qwa":"クァ","qa":"クァ","kwa":"クァ","qwi":"クィ","qi":"クィ","qyi":"クィ","qwu":"クゥ","qwe":"クェ","qe":"クェ","qye":"クェ","qwo":"クォ","qo":"クォ","gya":"ギャ","gyi":"ギィ","gyu":"ギュ","gye":"ギェ","gyo":"ギョ","gwa":"グァ","gwi":"グィ","gwu":"グゥ","gwe":"グェ","gwo":"グォ","sa":"サ","si":"シ","ci":"シ","shi":"シ","su":"ス","se":"セ","ce":"セ","so":"ソ","za":"ザ","zi":"ジ","ji":"ジ","zu":"ズ","ze":"ゼ","zo":"ゾ","sya":"シャ","sha":"シャ","syi":"シィ","syu":"シュ","shu":"シュ","sye":"シェ","she":"シェ","syo":"ショ","sho":"ショ","swa":"スァ","swi":"スィ","swu":"スゥ","swe":"スェ","swo":"スォ","zya":"ジャ","ja":"ジャ","jya":"ジャ","zyi":"ジィ","jyi":"ジィ","zyu":"ジュ","ju":"ジュ","jyu":"ジュ","zye":"ジェ","je":"ジェ","jye":"ジェ","zyo":"ジョ","jo":"ジョ","jyo":"ジョ","ta":"タ","ti":"チ","chi":"チ","tu":"ツ","tsu":"ツ","te":"テ","to":"ト","ltu":"ッ","xtu":"ッ","ltsu":"ッ","da":"ダ","di":"ヂ","du":"ヅ","de":"デ","do":"ド","tya":"チャ","cha":"チャ","cya":"チャ","tyi":"チィ","cyi":"チィ","tyu":"チュ","chu":"チュ","cyu":"チュ","tye":"チェ","che":"チェ","cye":"チェ","tyo":"チョ","cho":"チョ","cyo":"チョ","tsa":"ツァ","tsi":"ツィ","tse":"ツェ","tso":"ツォ","tha":"テャ","thi":"ティ","thu":"テュ","the":"テェ","tho":"テョ","twa":"トァ","twi":"トィ","twu":"トゥ","twe":"トェ","two":"トォ","dya":"ヂャ","dyi":"ヂィ","dyu":"ヂュ","dye":"ヂェ","dyo":"ヂョ","dha":"デャ","dhi":"ディ","dhu":"デュ","dhe":"デェ","dho":"デョ","dwa":"ドァ","dwi":"ドィ","dwu":"ドゥ","dwe":"ドェ","dwo":"ドォ","na":"ナ","ni":"ニ","nu":"ヌ","ne":"ネ","no":"ノ","nya":"ニャ|ンヤ","nyi":"ニィ","nyu":"ニュ|ンユ","nye":"ニェ","nyo":"ニョ|ンヨ","ha":"ハ","hi":"ヒ","hu":"フ","fu":"フ","he":"ヘ","ho":"ホ","ba":"バ","bi":"ビ","bu":"ブ","be":"ベ","bo":"ボ","pa":"パ","pi":"ピ","pu":"プ","pe":"ペ","po":"ポ","hya":"ヒャ","hyi":"ヒィ","hyu":"ヒュ","hye":"ヒェ","hyo":"ヒョ","fya":"フャ","fyu":"フュ","fyo":"フョ","fwa":"ファ","fa":"ファ","fwi":"フィ","fi":"フィ","fyi":"フィ","fwu":"フゥ","fwe":"フェ","fe":"フェ","fye":"フェ","fwo":"フォ","fo":"フォ","bya":"ビャ","byi":"ビィ","byu":"ビュ","bye":"ビェ","byo":"ビョ","va":"ヴァ","vi":"ヴィ","vu":"ヴ","ve":"ヴェ","vo":"ヴォ","vya":"ヴャ","vyi":"ヴィ","vyu":"ヴュ","vye":"ヴェ","vyo":"ヴョ","pya":"ピャ","pyi":"ピィ","pyu":"ピュ","pye":"ピェ","pyo":"ピョ","ma":"マ","mi":"ミ","mu":"ム","me":"メ","mo":"モ","mya":"ミャ","myi":"ミィ","myu":"ミュ","mye":"ミェ","myo":"ミョ","ya":"ヤ","yu":"ユ","yo":"ヨ","lya":"ャ","xya":"ャ","lyu":"ュ","xyu":"ュ","lyo":"ョ","xyo":"ョ","ra":"ラ","ri":"リ","ru":"ル","re":"レ","ro":"ロ","rya":"リャ","ryi":"リィ","ryu":"リュ","rye":"リェ","ryo":"リョ","wa":"ワ","wo":"ヲ","n":"ン","nn":"ン","n'":"ン","xn":"ン","lwa":"ヮ","xwa":"ヮ","bb":"ッ","cc":"ッ","dd":"ッ","ff":"ッ","gg":"ッ","hh":"ッ","jj":"ッ","kk":"ッ","ll":"ッ","mm":"ッ","pp":"ッ","qq":"ッ","rr":"ッ","ss":"ッ","tt":"ッ","vv":"ッ","ww":"ッ","xx":"ッ","yy":"ッ","zz":"ッ","-":"ー"};

function regularize_word(word) {
	// ひらがな → カタカナ
	// 半角カナ → カタカナ
	// 全角英数字 → 半角英数字
	var map = regularize_word.map;
	var chr = String.fromCharCode;
	return word.replace(/(?:[｡-ﾝ][ﾞﾟ]?|[ぁ-ゔ　！-～])/g, function(s) {
		var s1 = s.charAt(0);
		if ('｡' <= s1 && s1 <= 'ﾝ' && s.length == 2) {
			if (s.charAt(1) == 'ﾞ' && (('ｶ' <= s1 && s1 <= 'ﾄ') || ('ﾊ' <= s1 && s1 <= 'ﾎ'))) {
				return chr(map[s1].charCodeAt(0) + 1);
			} else if(s.charAt(1) == 'ﾟ' && 'ﾊ' <= s1 && s1 <= 'ﾎ') {
				return chr(map[s1].charCodeAt(0) + 2);
			} else {
				return map[s1] + s.charAt(1);
			}
		}
		if ('ぁ' <= s && s <= 'ゔ') {
			return chr(s.charCodeAt(0) - 'ぁ'.charCodeAt(0) + 'ァ'.charCodeAt(0));
		}
		if ('Ａ' <= s && s <= 'Ｚ') {
			return chr(s.charCodeAt(0) - 'Ａ'.charCodeAt(0) + 'A'.charCodeAt(0));
		}
		if ('ａ' <= s && s <= 'ｚ') {
			return chr(s.charCodeAt(0) - 'ａ'.charCodeAt(0) + 'a'.charCodeAt(0));
		}
		if ('！' <= s && s <= '～') {
			return chr(s.charCodeAt(0) - '！'.charCodeAt(0) + '!'.charCodeAt(0));
		}
		if (map.hasOwnProperty(s)) {
			return map[s];
		}
		return s;
	});
}

regularize_word.map = {'　': ' ', '｡': '。', '｢': '「', '｣': '」', '､': '、', '･': '・', 'ｦ': 'ヲ', 'ｧ': 'ァ', 'ｨ': 'ィ', 'ｩ': 'ゥ', 'ｪ': 'ェ', 'ｫ': 'ォ', 'ｬ': 'ャ', 'ｭ': 'ュ', 'ｮ': 'ョ', 'ｯ': 'ッ', 'ｰ': 'ー', 'ｱ': 'ア', 'ｲ': 'イ', 'ｳ': 'ウ', 'ｴ': 'エ', 'ｵ': 'オ', 'ｶ': 'カ', 'ｷ': 'キ', 'ｸ': 'ク', 'ｹ': 'ケ', 'ｺ': 'コ', 'ｻ': 'サ', 'ｼ': 'シ', 'ｽ': 'ス', 'ｾ': 'セ', 'ｿ': 'ソ', 'ﾀ': 'タ', 'ﾁ': 'チ', 'ﾂ': 'ツ', 'ﾃ': 'テ', 'ﾄ': 'ト', 'ﾅ': 'ナ', 'ﾆ': 'ニ', 'ﾇ': 'ヌ', 'ﾈ': 'ネ', 'ﾉ': 'ノ', 'ﾊ': 'ハ', 'ﾋ': 'ヒ', 'ﾌ': 'フ', 'ﾍ': 'ヘ', 'ﾎ': 'ホ', 'ﾏ': 'マ', 'ﾐ': 'ミ', 'ﾑ': 'ム', 'ﾒ': 'メ', 'ﾓ': 'モ', 'ﾔ': 'ヤ', 'ﾕ': 'ユ', 'ﾖ': 'ヨ', 'ﾗ': 'ラ', 'ﾘ': 'リ', 'ﾙ': 'ル', 'ﾚ': 'レ', 'ﾛ': 'ロ', 'ﾜ': 'ワ', 'ﾝ': 'ン'};

function elementWithIn(elem1, elem2) {
	// elem2 が elem1 と同一の要素か、elem1 の子孫要素のとき true を返す
	var elem = elem2;
	while (elem) {
		if (elem === elem1) return true;
		 elem = elem.parentNode;
	}
	return false;
}

function ary_include(ary, e) {
	return indexof(ary, e) >= 0;
}

function indexof(ary, e) {
	for (var i = 0; i < ary.length; i ++) {
		if (ary[i] === e) {
			return i;
		}
	}
	return -1;
}

function ary_eq(a, b) {
	if (a == b) return true;
	if (a.length != b.length) return false;
	var l = a.length;
	for (var i = 0; i < l; i ++) {
		if (a[i] !== b[i]) return false;
	}
	return true;
}

function ary_swap(array, i, j) {
	var tmp = array[i];
	array[i] = array[j];
	array[j] = tmp;
}

function map(array, fn) {
	var len = array.length;
	if (typeof fn === "string") fn = propname_callback(fn);
	var result = new Array(len);
	for (var i = 0; i < len; i ++) {
		result[i] = fn(array[i]);
	}
	return result;
}

function propname_callback(name) {
	return function(e) {
		return e[name];
	};
}

function format_hex(n, prec) {
	var s = n.toString(16);
	return "0x" + (str_repeat("0", prec - s.length) + s);
}

function format_dec(n, prec, c) {
	var s = String(n);
	return (str_repeat(c || "0", prec - s.length) + s);
}

function str_repeat(s, n) {
	var r = "";
	for (var i = 0; i < n; i ++) {
		r += s;
	}
	return r;
}

function rjust_name(name) {
	var width = name.length * 2;
	if (/[2Z]$/.test(name)) width -= 1; // ポリゴン[2Z]
	return str_repeat(" ", 10 - width) + name;
}

function step_seed(seed, n) {
	var fn = next_seed;
	if (n < 0) {
		fn = prev_seed;
		n = -n;
	}
	for (var i = 0; i < n; i ++) {
		seed = fn(seed);
	}
	return seed >>> 0;
}

function next_seed(seed) {
	return mul(seed, 0x41c64e6d) + 0x6073 >>> 0;
}

function prev_seed(seed) {
	return mul(seed, 0xeeb9eb65) + 0xa3561a1 >>> 0;
}

function mul(a, b) {
	var a1 = a >>> 16, a2 = a & 0xffff;
	var b1 = b >>> 16, b2 = b & 0xffff;
	return (((a1 * b2 + a2 * b1) << 16) + a2 * b2) >>> 0;
}
</script>
<style type="text/css">
#result table {
	border-collapse: collapse;
}

#result th,
#result td {
	padding: 0.1em 5px;
	border: 1px solid black;
}

span.range {
	font-size: 80%;
	color: #888;
}

div.progress {
	height: 10px;
	border: 1px solid #888;
	display: inline-block;
	*display: inline;
}

div.progress_bar {
	height: 100%;
	background: #4bd472;
}

body {
	/* 下に余白がないと7戦目の相手の技が見づらいので */
	padding-bottom: 5em;
}

#result button {
	font-size: x-small;
	color: #444;
	border: 1px solid #999;
	border-left-color: #eee;
	border-top-color:  #eee;
	background: #eee;
}

div.tooltip {
	position: absolute;
	top: 0;
	left: 0;
	border: 1px solid #000;
	padding: 3px;
	background: #ffc;
	font-size: 80%;
}

div.tooltip pre {
	margin: 0;
	padding: 0;
}

div.tooltip .collided {
	color: #dc143c;
}
</style>
</head>
<body>
<h1>ちょうさ・ぶんせきマシン （仮）</h1>
<p>Lv50 3周目まで限定</p>
<p><input type="text" id="shuu_input" size="2" value="1"> 周目</p>
<form action="" name="entries_form" onsubmit="return false;">
<p>6匹のポケモンと親IDで入力:</p>
<table><tr>
<td style="vertical-align:top">
<textarea cols="30" rows="6" id="entries">
マイナン　11067
パチリス　63599
ムクバード　62326
ハスブレロ　27843
パッチール　50041
カラナクシ　10484</textarea><br>
<input type="submit" name="entries_submit" value="決定">
<td style="vertical-align:top;width:14em">
<small>
全角・半角・ひらがな・カタカナは問いません。<br>
「pikachuu」のようにローマ字のままでもOKです。<br>
ボーナスポケモンは「○○○&nbsp;12345&nbsp;b」のように後ろにbをつけてください
</small>
</tr></table>
</form>
<form action="" name="seed_form" onsubmit="return false;">
<p>seed+消費量で入力: <input type="text" name="seed" size="15" value="0x00000000">+<input type="text" name="consumption" size="6" value="0"> ボーナスポケ: <input type="text" name="num_bonus" size="3" value="0"> 匹 <input type="submit" name="seed_submit" value="決定"></p>
</form>
<div id="result"></div>
</body>
</html>
