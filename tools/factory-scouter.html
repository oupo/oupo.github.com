<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>ちょうさ・ぶんせきマシン （仮）</title>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">
var factory_data = null;
var pokemon_data = null;
var pokemon_name2id = null;
var natures = "がんばりや さみしがり ゆうかん いじっぱり やんちゃ ずぶとい すなお のんき わんぱく のうてんき おくびょう せっかち まじめ ようき むじゃき ひかえめ おっとり れいせい てれや うっかりや おだやか おとなしい なまいき しんちょう きまぐれ".split(" ");
var shuu_pokemons_count = [null, 150, 100, 100, 136, 136, 136, 192];
var shuu_entries_start  = [null,   0, 150, 250, 350, 486, 622, 758];
var shuu_entries_end    = [null, 149, 249, 349, 485, 621, 757, 949];

$(function() {
	var factory_data_text;
	var pokedex_csv_text;
	$.ajax({dataType: "text", url: "factory_data.txt", success: function(data) {
		factory_data_text = data;
		boot();
	}});
	$.ajax({dataType: "text", url: "pokedex.csv", success: function(data) {
		pokedex_csv_text = data;
		boot();
	}});
	function boot() {
		if (!factory_data_text || !pokedex_csv_text) return;
		initialize_pokemon_data(pokedex_csv_text);
		initialize_factory_entries(factory_data_text);
		$(document.forms.entries_form).submit(on_submit_entries);
		$(document.forms.seed_form).submit(on_submit_seed);

	}
});

function initialize_pokemon_data(pokedex_csv_text) {
	var lines = pokedex_csv_text.split('\n');
	if (lines[lines.length - 1] == '') lines.pop();
	var boundaries = {"♂のみ": -1, "♀のみ": 255, "1:7": 30, "1:3": 63, "1:1": 126, "3:1": 190, "ふめい": null};
	pokemon_data = new Array(lines.length);
	pokemon_name2id = {};
	for (var i = 0; i < lines.length; i ++) {
		var row = lines[i].split(',');
		var name = row[0];
		var ability1 = row[1];
		var ability2 = row[2] || ability1;
		var gender_boundary = boundaries[row[3]];
		pokemon_name2id[name] = i;
		pokemon_data[i] = {
			id: i,
			name: name,
			abilities: [ability1, ability2],
			gender_boundary: gender_boundary
		};
	}
}

function initialize_factory_entries(factory_data_text) {
	var lines = factory_data_text.split('\n');
	if (lines[lines.length - 1] == '') lines.pop();
	factory_data = new Array(lines.length);
	for (var i = 0; i < lines.length; i ++) {
		var row = lines[i].split('|');
		factory_data[i] = {
			id: i,
			name:   row[1],
			pokemon: get_pokemon_entry(row[1]),
			nature: indexof(natures, row[2]),
			item:   row[3],
			move:   row[4],
			effort: row[5]
		};
	}
}

var context = null;
var during_search = false;

function on_submit_entries() {
	if (during_search) return;
	var shuu = read_shuu_input();
	if (shuu === null) return;
	var f = document.forms.entries_form;
	var r = parse_text(shuu, f.entries.value);
	if (!r) return;
	var num_bonus = FindSeedProcedure.gen_bonus_entries(shuu, r.entries).length;
	var procedure = new FindSeedProcedure(shuu, r.entries, r.parent_ids);
	var progress_div;
	during_search = true;
	(function loop() {
		var seed = procedure.run(100);
		if (seed === "timeout") {
			if (!progress_div) progress_div = build_progress_div();
			set_progress(progress_div, procedure.get_ratio());
			setTimeout(loop, 0);
		} else {
			if (progress_div) remove_progress_div(progress_div);
			during_search = false;
			build_result_div(shuu, seed, 0, num_bonus);
		}
	})();
}

function on_submit_seed() {
	if (during_search) return;
	var shuu = read_shuu_input();
	if (shuu === null) return;
	var f = document.forms.seed_form;
	var seed = read_int_string(f.seed.value);
	var consumption = read_int_string(f.consumption.value, 0);
	var num_bonus = read_int_string(f.num_bonus.value, 0);
	if (seed === null) {
		alert("seedに入力されている値が不正です");
		return;
	}
	if (consumption === null) {
		alert("消費量に入力されている値が不正です");
		return;
	}
	if (num_bonus === null || num_bonus < 0 || num_bonus > 6) {
		alert("ボーナスポケモンの数に入力されている値が不正です");
		return;
	}
	seed = step_seed(seed, consumption);
	build_result_div(shuu, seed, consumption, num_bonus);
}

function read_shuu_input() {
	var value = read_int_string(document.getElementById("shuu_input").value);
	if (value === null || value < 1 || value > 3) {
		alert("周に入力されている値が不正です");
		return null;
	}
	return value;
}

var progress_width = 100;

function build_progress_div() {
	var p = document.forms.entries_form.entries_submit.parentNode;
	var div = document.createElement("div");
	div.className = "progress";
	div.style.width = (progress_width + 2) + "px";
	var bar = document.createElement("div");
	bar.className = "progress_bar";
	div.appendChild(bar);
	p.appendChild(div);
	return div;
}

function set_progress(div, ratio) {
	div.firstChild.style.width = Math.floor(ratio * progress_width) + "px";
}

function remove_progress_div(div) {
	div.parentNode.removeChild(div);
}

function build_result_div(shuu, seed, consumption, num_bonus) {
	var div = document.getElementById("result");
	if (seed === null) {
		div.innerHTML = "<p>その組み合わせのseedが見つかりません</p>";
		return;
	}
	var r = get_6_entries_info(shuu, seed, consumption, num_bonus);
	var entries = r.entries;
	var seed_head = seed;
	seed = r.seed;
	var entries_in_hand = entries.slice(0, 3);
	context = {shuu: shuu,
	           infos: [r]};
	
	var buf = [];
	buf.push("<p>6匹決定時のseed: "+format_hex(seed_head, 8)+"</p>");
	buf.push("<p id=\"range-0\" class=\"range\">"+r.rand_range.first+"-"+r.rand_range.last+"</p>");
	build_table(buf, r.infos);
	buf.push("<p id=\"election\">選出: "+build_select(entries, 0)+" "+build_select(entries, 1)+" "+build_select(entries, 2)+"</p>");
	buf.push("<p>1戦目</p>");
	var r = get_3_entries_info(shuu, seed, r.next_consumption, entries, entries_in_hand);
	context.infos.push(r);
	buf.push("<p id=\"range-1\" class=\"range\">"+r.rand_range.first+"-"+r.rand_range.last+"</p>");
	buf.push("<div id=\"enemy-entries-1\">");
	build_table(buf, r.infos);
	buf.push("</div>");
	seed = step_seed(r.seed, 24);
	consumption = r.next_consumption + 24;
	var prev_enemy_entries = r.entries;
	for (var i = 2; i <= 7; i ++) {
		var visited_entries = entries_in_hand.concat(prev_enemy_entries);
		var r = get_3_entries_info(i == 7 ? shuu + 1 : shuu, seed, consumption, visited_entries, entries_in_hand);
		context.infos.push(r);
		buf.push("<p class=\"exchange\">交換: <select id=\"exchange-part-"+(i-1)+"\"><option></option>"+build_options(entries_in_hand)+"</select>");
		buf.push("→ <select id=\"exchange-receive-"+(i-1)+"\"><option></option>"+build_options(prev_enemy_entries)+"</select>");
		buf.push(" (手持ち: <span id=\"entries-in-hand-"+i+"\">"+map(entries_in_hand, "name").join(" ")+"</span>)</p>");
		buf.push("<p>"+i+"戦目</p>");
		buf.push("<p id=\"range-"+i+"\" class=\"range\">"+r.rand_range.first+"-"+r.rand_range.last+"</p>");
		buf.push("<div id=\"enemy-entries-"+i+"\">");
		build_table(buf, r.infos);
		buf.push("</div>");
		seed = step_seed(r.seed, 6);
		consumption = r.next_consumption + 6;
		prev_enemy_entries = r.entries;
	}
	div.innerHTML = buf.join("");
	$("#election select").change(on_select_change).keypress(on_select_change);
	$("#result > p.exchange select").change(on_exchange_select_change).keypress(on_exchange_select_change);
}

function read_int_string(s, default_value) {
	if (/^\s*$/.test(s) && default_value !== undefined) {
		return default_value;
	}
	if (!/^\s*(?:-?\d+|0x[0-9a-f]+)\s*$/i.test(s)) {
		return null;
	}
	return Number(s);
}

function parse_text(shuu, text) {
	var lines = regularize_word(text).split("\n");
	var entries = [];
	var parent_ids = [];
	for (var i = 0; i < lines.length; i ++) {
		var line = lines[i];
		if (/^\s*$/.test(line)) continue;
		// [ポケモンの種類ID] 名前 親ID [b]
		// 結果に表示された表からコピペで入力できるように「1 フシギダネ 12345」のような形式を認める
		var m = /^\s*((?:\d+\s+)?)(\S+)\s+(\d+)((?:\s+b)?)\s*$/.exec(line);
		if (!m) {
			alert((i+1)+"行目が不正です\n> "+line);
			return null;
		}
		var id = read_int_string(m[1]), name = m[2], parent_id = Number(m[3]), is_bonus = m[4] !== "";
		if (entries.length == 6) {
			alert("6匹より多く入力されています");
			return null;
		}
		var entry;
		if (id !== null) {
			if (id - 1 < shuu_entries_start[shuu] || id - 1 > shuu_entries_end[shuu+1]) {
				alert((i+1)+"行目: "+id+"は不正なNoです");
				return;
			}
			entry = factory_data[id - 1];
			if (find_factory_entry(entry_id_to_shuu(id - 1), name) !== entry) {
				alert((i+1)+"行目: "+id+"と"+name+"が一致しません ("+id+" = "+entry.name+")");
				return;
			}
		} else if (is_bonus) {
			entry = find_factory_entry(shuu + 1, name);
		} else {
			entry = find_factory_entry(shuu, name);
			if(!entry) entry = find_factory_entry(shuu + 1, name);
		}
		if (!entry) {
			alert((i+1)+"行目: \""+name+"\"は存在しません");
			return null;
		}
		if (parent_id < 0 || parent_id >= 65536) {
			alert((i+1)+"行目: "+parent_id+"は不正なIDです");
			return null;
		}
		if (ary_include(entries, entry)) {
			alert((i+1)+"行目: "+entry.name+"が重複しています");
			return null;
		}
		if (entries_collision0(entry, entries)) {
			alert((i+1)+"行目: "+entry.name+"はアイテムが重複しています");
			return null;
		}
		entries.push(entry);
		parent_ids.push(parent_id);
	}
	if (entries.length != 6) {
		alert("6匹入力されていません");
		return null;
	}
	return {entries: entries, parent_ids: parent_ids};
}

function entry_id_to_shuu(id) {
	if (id < 150) return 1;
	if (id < 250) return 2;
	if (id < 350) return 3;
	if (id < 486) return 4;
	if (id < 622) return 5;
	if (id < 758) return 6;
	return 7;
}

function on_select_change() {
	var shuu = context.shuu;
	var six_entries = context.infos[0].entries;
	var selects = $("#election select");
	var entries_in_hand = [];
	for (var i = 0; i < 3; i ++) {
		var select = selects[i];
		var entry = six_entries[select.selectedIndex];
		entries_in_hand.push(entry);
	}
	if (!ary_eq(context.infos[1].entries_in_hand, entries_in_hand)) {
		context.infos[1].entries_in_hand = entries_in_hand;
		change_enemy_entries(2);
	}
}

function on_exchange_select_change() {
	var n = Number(/^exchange-(?:part|receive)-(\d)/.exec(this.id)[1]);
	var part = document.getElementById("exchange-part-"+n).selectedIndex - 1;
	var receive = document.getElementById("exchange-receive-"+n).selectedIndex - 1;
	var entries_in_hand = context.infos[n].entries_in_hand.slice();
	var enemy_entries = context.infos[n].entries;
	if (part !== -1 && receive !== -1) {
		entries_in_hand[part] = enemy_entries[receive];
	}
	if (!ary_eq(context.infos[n + 1].entries_in_hand, entries_in_hand)) {
		context.infos[n + 1].entries_in_hand = entries_in_hand;
		change_entries_in_hand_text(n + 1);
		// n戦目後に交換してもn+1戦目の3匹は変わらない。n+2戦目以降の3匹が変わる。
		if (n + 2 <= 7) {
			change_enemy_entries(n + 2);
		}
	}
}

function change_enemy_entries(start) {
	var prev_enemy_entries = context.infos[start - 1].entries;
	var shuu = context.shuu;
	var seed = context.infos[start].seed_start;
	var consumption = context.infos[start].rand_range.first;
	var entries_in_hand = context.infos[start - 1].entries_in_hand;
	for (var i = start; i <= 7; i ++) {
		var visited_entries = entries_in_hand.concat(prev_enemy_entries);
		var r = get_3_entries_info(i == 7 ? shuu + 1 : shuu, seed, consumption, visited_entries, entries_in_hand);
		context.infos[i] = r;
		
		$("#exchange-part-"+(i-1)).html("<option></option>"+build_options(entries_in_hand));
		$("#exchange-receive-"+(i-1)).html("<option></option>"+build_options(prev_enemy_entries));
		change_entries_in_hand_text(i);
		
		$("#range-"+i).text(r.rand_range.first+"-"+r.rand_range.last);
		
		var div = document.getElementById("enemy-entries-"+i);
		var buf = [];
		build_table(buf, r.infos)
		div.innerHTML = buf.join("");
		seed = step_seed(r.seed, 6);
		consumption = r.next_consumption + 6;
		prev_enemy_entries = r.entries;
	}
}

function change_entries_in_hand_text(i) {
	$("#entries-in-hand-"+i).text(map(context.infos[i].entries_in_hand, "name").join(" "));
}

function build_select(entries, selectedIndex) {
	return "<select>" + build_options(entries, selectedIndex) + "</select>";
}

function build_options(entries, selectedIndex) {
	var buf = "";
	for (var i = 0; i < entries.length; i ++) {
		buf += "<option"+(selectedIndex===i ? " selected " : "")+">"+entries[i].name+"</option>";
	}
	return buf;
}

function build_table(buf, info) {
	buf.push("<table><thead><tr><th>周<th>No<th>名前<th>ID<th>裏ID<th>性格値<th>性別<th>特性</tr></thead>");
	buf.push("<tbody>");
	for (var i = 0; i < info.length; i ++) {
		var e = info[i];
		var pid = e.pid;
		var entry = e.entry;
		buf.push("<tr>"+
		         "<td>"+entry_id_to_shuu(entry.id)+
		         "<td>"+(entry.id+1)+
		         "<td>"+entry.name+
		         "<td>"+format_dec(e.parent_id, 5)+
		         "<td>"+format_dec(e.secret_id, 5)+
		         "<td>"+format_hex(pid, 8)+
		         "<td>"+pid2gender(pid, entry.pokemon)+
		         "<td>"+entry.pokemon.abilities[pid % 2]+"</tr>");
	}
	buf.push("</tbody></table>");
}

function get_pokemon_entry(name) {
	return pokemon_data[pokemon_name2id[name]];
}

function pid2gender(pid, pokemon) {
	var boundary = pokemon.gender_boundary;
	if (boundary !== null) {
		return (pid & 0xff) > boundary ? "♂" : "♀";
	} else {
		return "不明";
	}
}

function seed_to_entry_id(shuu, seed) {
	var count = shuu_pokemons_count[shuu];
	var start = shuu_entries_start[shuu];
	return count - 1 - (seed >>> 16) % count + start;
}

function seed_to_entry(shuu, seed) {
	return factory_data[seed_to_entry_id(shuu, seed)];
}

function get_3_entries_info(shuu, seed, consumption, visited_entries, entries_in_hand) {
	return get_entries_info(shuu, seed, consumption, 3, visited_entries, entries_in_hand, 0);
}

function get_6_entries_info(shuu, seed, consumption, num_bonus) {
	return get_entries_info(shuu, seed, consumption, 6, [], null, num_bonus);
}

function get_entries_info(shuu, seed, consumption, num, visited_entries, entries_in_hand, num_bonus) {
	var entries = [];
	var infos = [];
	var i = 0;
	var seed_start = seed;
	var c = consumption;
	while (i < num) {
		var is_bonus = num - i <= num_bonus;
		var entry = seed_to_entry(is_bonus ? shuu + 1 : shuu, seed);
		seed = next_seed(seed); c ++;
		if (entries_collision(entry, entries, visited_entries)) continue;
		entries.push(entry);
		i ++;
	}
	
	for (var i = 0; i < num; i ++) {
		var parent_id = seed >>> 16;
		seed = next_seed(seed); c ++;
		var secret_id = seed >>> 16;
		seed = next_seed(seed); c ++;
		var nature = entries[i].nature;
		do {
			var pid_row = seed >>> 16;
			seed = next_seed(seed); c ++;
			var pid_high = seed >>> 16;
			seed = next_seed(seed); c ++;
			var pid = (pid_high << 16 | pid_row) >>> 0;
		} while (pid % 25 != nature || is_shiny_pid(parent_id, secret_id, pid));
		infos.push({entry: entries[i],
		            parent_id: parent_id,
		            secret_id: secret_id,
		            pid: pid});
	}
	
	var range = {first: consumption, last: c - 1};
	
	if (num === 6) {
		var swap1 = (seed >>> 16) % 6;
		seed = next_seed(seed); c ++;
		var swap2 = (seed >>> 16) % 6;
		seed = next_seed(seed); c ++;
		
		ary_swap(infos, 4, swap1);
		ary_swap(infos, 5, swap2);
		
		ary_swap(entries, 4, swap1);
		ary_swap(entries, 5, swap2);
	}
	
	return {entries: entries,
	        infos: infos,
	        seed: seed,
	        seed_start: seed_start,
	        rand_range: range,
	        next_consumption: c,
	        entries_in_hand: entries_in_hand};
}

function entries_collision(entry, entries, visited_entries) {
	return entries_collision0(entry, entries) || entries_collision0(entry, visited_entries);
}

function entries_collision0(entry, entries) {
	for (var i = 0; i < entries.length; i ++) {
		if (entry === entries[i]) return true;
		if (entry.item === entries[i].item) return true;
	}
	return false;
}

function FindSeedProcedure(shuu, entries, parent_ids) {
	this.shuu = shuu;
	this.entries = entries;
	this.parent_ids = parent_ids;
	this.items = FindSeedProcedure.gen_items(entries);
	this.bonus_entries = FindSeedProcedure.gen_bonus_entries(shuu, entries);
	if (this.bonus_entries.length == 6) {
		this.bonus_entries = [];
		this.shuu += 1;
	}
	this.num_bonus = this.bonus_entries.length;
	this.last_candidate_entries = this.num_bonus > 0 ? this.bonus_entries : this.entries;
	this.last_entry_shuu = this.num_bonus > 0 ? this.shuu + 1 : this.shuu;
	this.ns = FindSeedProcedure.gen_ns(shuu, entries);
	this.i = 0;
	this.j = 0;
}

FindSeedProcedure.gen_items = function(entries) {
	var result = [];
	for (var i = 0; i < entries.length; i ++) {
		result.push(entries[i].item);
	}
	return result;
};

FindSeedProcedure.gen_bonus_entries = function(shuu, entries) {
	var start = shuu_entries_start[shuu + 1];
	var result = [];
	for (var i = 0; i < 6; i ++) {
		var entry = entries[i];
		if (entry.id >= start) result.push(entry);
	}
	return result;
};

FindSeedProcedure.gen_ns = function(shuu, entries) {
	var start = shuu_entries_start[shuu + 1];
	var _ns = [0, 4, 5];
	var ns = [];
	for (var i = 0; i < 3; i ++) {
		var n = _ns[i];
		// ボーナスポケモンは先頭になるはずがないので除外
		if (entries[n].id < start) {
			ns.push(n);
		}
	}
	return ns;
};

FindSeedProcedure.prototype.run = function(timeout) {
	var start_time = + new Date;
	var start_i = this.i;
	for (; this.i < this.ns.length; this.i ++) {
		var n = this.ns[this.i];
		var entry = this.entries[n];
		var parent_id = this.parent_ids[n];
		var j = this.i === start_i ? this.j : 0;
		for (; j < 65536; j ++) {
			var seed = (parent_id << 16 | j) >>> 0;
			seed_head = this.match_entries(seed, entry);
			if (seed_head !== null) return seed_head;
			if ((j & 255) === 0 && new Date - start_time >= timeout) {
				this.j = j + 1;
				return "timeout";
			}
		}
	}
	return null;
};

FindSeedProcedure.prototype.get_ratio = function() {
	return (this.i * 65536 + this.j) / (this.ns.length * 65536);
}

FindSeedProcedure.prototype.match_entries = function(seed, first_entry) {
	var last_entry = seed_to_entry(this.last_entry_shuu, prev_seed(seed));
	if (!ary_include(this.last_candidate_entries, last_entry)) return null;
	var n = 6;
	var seed_head = step_seed(seed, -n);
	// 乱数列が A,B,C,D,E,A,F のとき raw_entries は B,C,D,E,A,F になるので先頭要素が一致しなくなる
	// 先頭要素が一致しない場合はさらに前の乱数列をさかのぼってみる。
	for (;;seed_head=prev_seed(seed_head),n++) {
		var s = seed;
		var raw_entries = this.find_entries(seed_head, n);
		if (raw_entries === "break") break;
		if (raw_entries === "next") continue;
		if (raw_entries[0] !== first_entry) {
			// 先頭要素が一致しない
			continue;
		}
		var s = this.match_parent_ids(seed, raw_entries);
		if (s === null) continue;
		var swap1 = (s >>> 16) % 6;
		s= next_seed(s);
		var swap2 = (s >>> 16) % 6;
		if (!this.match_swap(raw_entries, swap1, swap2)) continue;
		return seed_head;
	}
	return null;
};

FindSeedProcedure.prototype.find_entries = function(seed, n) {
	var shuu = this.shuu;
	var raw_entries = [];
	var steps = 0;
	var i = 0, num = 6 - this.num_bonus;
	while (i < 6) {
		var is_bonus = 6 - i <= this.num_bonus;
		var s = seed;
		var entry = seed_to_entry(is_bonus ? shuu + 1 : shuu, seed);
		seed = next_seed(seed);
		steps ++;
		if (steps > n) return "next";
		if (entries_collision0(entry, raw_entries)) continue;
		// アイテムも一致しないエントリが存在した場合
		if (!ary_include(this.items, entry.item)) {
			// ボーナスポケモン決定時でアイテム重複でスキップされたエントリかもしれない
			var item = seed_to_entry(shuu + 1, s).item;
			if (this.num_bonus > 0 && !is_bonus && ary_include(this.items, item)) {
				return "next";
			} else {
				return "break";
			}
		}
		raw_entries.push(entry);
		i ++;
	}
	if (steps !== n) return "next";
	for (var i = 0; i < 6; i ++) {
		if(!ary_include(this.entries, raw_entries[i])) {
			return "next";
		}
	}
	return raw_entries;
};

FindSeedProcedure.prototype.match_swap = function(raw_entries, swap1, swap2) {
	raw_entries = raw_entries.slice();
	ary_swap(raw_entries, 4, swap1);
	ary_swap(raw_entries, 5, swap2);
	return ary_eq(this.entries, raw_entries);
};

FindSeedProcedure.prototype.match_parent_ids = function (seed, raw_entries) {
	for (var i = 0; i < 6; i ++) {
		var entry = raw_entries[i];
		var expected_parent_id = this.parent_ids[indexof(this.entries, entry)];
		var parent_id = seed >>> 16;
		seed = next_seed(seed);
		if (parent_id !== expected_parent_id) return null;
		var secret_id = seed >>> 16;
		seed = next_seed(seed);
		var nature = entry.nature;
		do {
			var pid_row = seed >>> 16;
			seed = next_seed(seed);
			var pid_high = seed >>> 16;
			seed = next_seed(seed);
			var pid = (pid_high << 16 | pid_row) >>> 0;
		} while (pid % 25 != nature || is_shiny_pid(parent_id, secret_id, pid));
	}
	return seed;
};

function is_shiny_pid(parent_id, secret_id, pid) {
	return ((parent_id ^ secret_id ^ (pid >>> 16) ^ (pid & 0xffff)) & ~7) == 0;
}

function find_factory_entry(shuu, name) {
	var re = roma2reg(name);
	var start = shuu_entries_start[shuu];
	var end = shuu_entries_end[shuu];
	for (var i = start; i <= end; i ++) {
		if (re.test(factory_data[i].name)) {
			return factory_data[i];
		}
	}
	return null;
}

function roma2reg(text) {
	var result = [];
	var len = 0;
	for (var i = 0; i < text.length; i += len) {
		len = 1;
		var t = text.charAt(i)
		if (!/[a-z-]/.test(t)) {
			result.push(regexp_escape(t));
			continue;
		}
		var token = roma2reg_search_token(text, i);
		if (!token) {
			result.push(t);
			continue;
		}
		var kana = roma2reg.kana_map[token];
		if (token.length == 2 && kana == "ッ") {
			result.push("(?:" + token.charAt(0) + "|" + kana + ")");
		} else {
			result.push("(?:" + token + "|" + kana + ")");
			len = token.length;
		}
	}
	return new RegExp("^"+result.join("")+"$");
}

function regexp_escape(s) {
	return s.replace(/\W/g,'\\$&');
}

function roma2reg_search_token(text, i) {
	for (var n = 4; n >= 1; n --) {
		var token = text.substr(i, n);
		if (roma2reg.kana_map.hasOwnProperty(token)) {
			return token;
		}
	}
	return null;
}

roma2reg.kana_map = {"a":"ア","i":"イ","yi":"イ","u":"ウ","wu":"ウ","whu":"ウ","e":"エ","o":"オ","la":"ァ","xa":"ァ","li":"ィ","xi":"ィ","lyi":"ィ","xyi":"ィ","lu":"ゥ","xu":"ゥ","le":"ェ","xe":"ェ","lye":"ェ","xye":"ェ","lo":"ォ","xo":"ォ","wha":"ウァ","whi":"ウィ","wi":"ウィ","whe":"ウェ","we":"ウェ","who":"ウォ","ka":"カ","ca":"カ","ki":"キ","ku":"ク","cu":"ク","qu":"ク","ke":"ケ","ko":"コ","co":"コ","lka":"ヵ","xka":"ヵ","lke":"ヶ","xke":"ヶ","ga":"ガ","gi":"ギ","gu":"グ","ge":"ゲ","go":"ゴ","kya":"キャ","kyi":"キィ","kyu":"キュ","kye":"キェ","kyo":"キョ","qya":"クャ","qyu":"クュ","qwa":"クァ","qa":"クァ","kwa":"クァ","qwi":"クィ","qi":"クィ","qyi":"クィ","qwu":"クゥ","qwe":"クェ","qe":"クェ","qye":"クェ","qwo":"クォ","qo":"クォ","gya":"ギャ","gyi":"ギィ","gyu":"ギュ","gye":"ギェ","gyo":"ギョ","gwa":"グァ","gwi":"グィ","gwu":"グゥ","gwe":"グェ","gwo":"グォ","sa":"サ","si":"シ","ci":"シ","shi":"シ","su":"ス","se":"セ","ce":"セ","so":"ソ","za":"ザ","zi":"ジ","ji":"ジ","zu":"ズ","ze":"ゼ","zo":"ゾ","sya":"シャ","sha":"シャ","syi":"シィ","syu":"シュ","shu":"シュ","sye":"シェ","she":"シェ","syo":"ショ","sho":"ショ","swa":"スァ","swi":"スィ","swu":"スゥ","swe":"スェ","swo":"スォ","zya":"ジャ","ja":"ジャ","jya":"ジャ","zyi":"ジィ","jyi":"ジィ","zyu":"ジュ","ju":"ジュ","jyu":"ジュ","zye":"ジェ","je":"ジェ","jye":"ジェ","zyo":"ジョ","jo":"ジョ","jyo":"ジョ","ta":"タ","ti":"チ","chi":"チ","tu":"ツ","tsu":"ツ","te":"テ","to":"ト","ltu":"ッ","xtu":"ッ","ltsu":"ッ","da":"ダ","di":"ヂ","du":"ヅ","de":"デ","do":"ド","tya":"チャ","cha":"チャ","cya":"チャ","tyi":"チィ","cyi":"チィ","tyu":"チュ","chu":"チュ","cyu":"チュ","tye":"チェ","che":"チェ","cye":"チェ","tyo":"チョ","cho":"チョ","cyo":"チョ","tsa":"ツァ","tsi":"ツィ","tse":"ツェ","tso":"ツォ","tha":"テャ","thi":"ティ","thu":"テュ","the":"テェ","tho":"テョ","twa":"トァ","twi":"トィ","twu":"トゥ","twe":"トェ","two":"トォ","dya":"ヂャ","dyi":"ヂィ","dyu":"ヂュ","dye":"ヂェ","dyo":"ヂョ","dha":"デャ","dhi":"ディ","dhu":"デュ","dhe":"デェ","dho":"デョ","dwa":"ドァ","dwi":"ドィ","dwu":"ドゥ","dwe":"ドェ","dwo":"ドォ","na":"ナ","ni":"ニ","nu":"ヌ","ne":"ネ","no":"ノ","nya":"ニャ|ンヤ","nyi":"ニィ","nyu":"ニュ|ンユ","nye":"ニェ","nyo":"ニョ|ンヨ","ha":"ハ","hi":"ヒ","hu":"フ","fu":"フ","he":"ヘ","ho":"ホ","ba":"バ","bi":"ビ","bu":"ブ","be":"ベ","bo":"ボ","pa":"パ","pi":"ピ","pu":"プ","pe":"ペ","po":"ポ","hya":"ヒャ","hyi":"ヒィ","hyu":"ヒュ","hye":"ヒェ","hyo":"ヒョ","fya":"フャ","fyu":"フュ","fyo":"フョ","fwa":"ファ","fa":"ファ","fwi":"フィ","fi":"フィ","fyi":"フィ","fwu":"フゥ","fwe":"フェ","fe":"フェ","fye":"フェ","fwo":"フォ","fo":"フォ","bya":"ビャ","byi":"ビィ","byu":"ビュ","bye":"ビェ","byo":"ビョ","va":"ヴァ","vi":"ヴィ","vu":"ヴ","ve":"ヴェ","vo":"ヴォ","vya":"ヴャ","vyi":"ヴィ","vyu":"ヴュ","vye":"ヴェ","vyo":"ヴョ","pya":"ピャ","pyi":"ピィ","pyu":"ピュ","pye":"ピェ","pyo":"ピョ","ma":"マ","mi":"ミ","mu":"ム","me":"メ","mo":"モ","mya":"ミャ","myi":"ミィ","myu":"ミュ","mye":"ミェ","myo":"ミョ","ya":"ヤ","yu":"ユ","yo":"ヨ","lya":"ャ","xya":"ャ","lyu":"ュ","xyu":"ュ","lyo":"ョ","xyo":"ョ","ra":"ラ","ri":"リ","ru":"ル","re":"レ","ro":"ロ","rya":"リャ","ryi":"リィ","ryu":"リュ","rye":"リェ","ryo":"リョ","wa":"ワ","wo":"ヲ","n":"ン","nn":"ン","n'":"ン","xn":"ン","lwa":"ヮ","xwa":"ヮ","bb":"ッ","cc":"ッ","dd":"ッ","ff":"ッ","gg":"ッ","hh":"ッ","jj":"ッ","kk":"ッ","ll":"ッ","mm":"ッ","pp":"ッ","qq":"ッ","rr":"ッ","ss":"ッ","tt":"ッ","vv":"ッ","ww":"ッ","xx":"ッ","yy":"ッ","zz":"ッ","-":"ー"};

function regularize_word(word) {
	// ひらがな → カタカナ
	// 半角カナ → カタカナ
	// 全角英数字 → 半角英数字
	// 大文字 → 小文字
	var map = regularize_word.map;
	var chr = String.fromCharCode;
	return word.replace(/(?:[｡-ﾝ][ﾞﾟ]?|[A-Zぁ-ゔ　！-～])/g, function(s) {
		var s1 = s.charAt(0);
		if ('｡' <= s1 && s1 <= 'ﾝ' && s.length == 2) {
			if (s.charAt(1) == 'ﾞ' && (('ｶ' <= s1 && s1 <= 'ﾄ') || ('ﾊ' <= s1 && s1 <= 'ﾎ'))) {
				return chr(map[s1].charCodeAt(0) + 1);
			} else if(s.charAt(1) == 'ﾟ' && 'ﾊ' <= s1 && s1 <= 'ﾎ') {
				return chr(map[s1].charCodeAt(0) + 2);
			} else {
				return map[s1] + s.charAt(1);
			}
		}
		if ('ぁ' <= s && s <= 'ゔ') {
			return chr(s.charCodeAt(0) - 'ぁ'.charCodeAt(0) + 'ァ'.charCodeAt(0));
		}
		if ('Ａ' <= s && s <= 'Ｚ') {
			return chr(s.charCodeAt(0) - 'Ａ'.charCodeAt(0) + 'a'.charCodeAt(0));
		}
		if ('A' <= s && s <= 'Z') {
			return chr(s.charCodeAt(0) - 'A'.charCodeAt(0) + 'a'.charCodeAt(0));
		}
		if ('！' <= s && s <= '～') {
			return chr(s.charCodeAt(0) - '！'.charCodeAt(0) + '!'.charCodeAt(0));
		}
		if (map.hasOwnProperty(s)) {
			return map[s];
		}
		return s;
	});
}

regularize_word.map = {'　': ' ', '｡': '。', '｢': '「', '｣': '」', '､': '、', '･': '・', 'ｦ': 'ヲ', 'ｧ': 'ァ', 'ｨ': 'ィ', 'ｩ': 'ゥ', 'ｪ': 'ェ', 'ｫ': 'ォ', 'ｬ': 'ャ', 'ｭ': 'ュ', 'ｮ': 'ョ', 'ｯ': 'ッ', 'ｰ': 'ー', 'ｱ': 'ア', 'ｲ': 'イ', 'ｳ': 'ウ', 'ｴ': 'エ', 'ｵ': 'オ', 'ｶ': 'カ', 'ｷ': 'キ', 'ｸ': 'ク', 'ｹ': 'ケ', 'ｺ': 'コ', 'ｻ': 'サ', 'ｼ': 'シ', 'ｽ': 'ス', 'ｾ': 'セ', 'ｿ': 'ソ', 'ﾀ': 'タ', 'ﾁ': 'チ', 'ﾂ': 'ツ', 'ﾃ': 'テ', 'ﾄ': 'ト', 'ﾅ': 'ナ', 'ﾆ': 'ニ', 'ﾇ': 'ヌ', 'ﾈ': 'ネ', 'ﾉ': 'ノ', 'ﾊ': 'ハ', 'ﾋ': 'ヒ', 'ﾌ': 'フ', 'ﾍ': 'ヘ', 'ﾎ': 'ホ', 'ﾏ': 'マ', 'ﾐ': 'ミ', 'ﾑ': 'ム', 'ﾒ': 'メ', 'ﾓ': 'モ', 'ﾔ': 'ヤ', 'ﾕ': 'ユ', 'ﾖ': 'ヨ', 'ﾗ': 'ラ', 'ﾘ': 'リ', 'ﾙ': 'ル', 'ﾚ': 'レ', 'ﾛ': 'ロ', 'ﾜ': 'ワ', 'ﾝ': 'ン'};

function ary_include(ary, e) {
	return indexof(ary, e) >= 0;
}

function indexof(ary, e) {
	for (var i = 0; i < ary.length; i ++) {
		if (ary[i] === e) {
			return i;
		}
	}
	return -1;
}

function ary_eq(a, b) {
	if (a == b) return true;
	if (a.length != b.length) return false;
	var l = a.length;
	for (var i = 0; i < l; i ++) {
		if (a[i] !== b[i]) return false;
	}
	return true;
}

function ary_swap(array, i, j) {
	var tmp = array[i];
	array[i] = array[j];
	array[j] = tmp;
}

function map(array, fn) {
	var len = array.length;
	if (typeof fn === "string") fn = propname_callback(fn);
	var result = new Array(len);
	for (var i = 0; i < len; i ++) {
		result[i] = fn(array[i]);
	}
	return result;
}

function propname_callback(name) {
	return function(e) {
		return e[name];
	};
}

function format_hex(n, prec) {
	return "0x" + (str_repeat("0", prec - 1) + n.toString(16)).slice(-prec);
}

function format_dec(n, prec) {
	return (str_repeat("0", prec - 1) + n).slice(-prec);
}

function str_repeat(s, n) {
	var r = "";
	for (var i = 0; i < n; i ++) {
		r += s;
	}
	return r;
}

function step_seed(seed, n) {
	var fn = next_seed;
	if (n < 0) {
		fn = prev_seed;
		n = -n;
	}
	for (var i = 0; i < n; i ++) {
		seed = fn(seed);
	}
	return seed >>> 0;
}

function next_seed(seed) {
	return mul(seed, 0x41c64e6d) + 0x6073 >>> 0;
}

function prev_seed(seed) {
	return mul(seed, 0xeeb9eb65) + 0xa3561a1 >>> 0;
}

function mul(a, b) {
	var a1 = a >>> 16, a2 = a & 0xffff;
	var b1 = b >>> 16, b2 = b & 0xffff;
	return (((a1 * b2 + a2 * b1) << 16) + a2 * b2) >>> 0;
}
</script>
<style type="text/css">
#result table {
	border-collapse: collapse;
}

#result th,
#result td {
	padding: 0.1em 5px;
	border: 1px solid black;
}

p.range {
	font-size: 80%;
	color: #888;
}

div.progress {
	height: 10px;
	border: 1px solid #888;
	display: inline-block;
	*display: inline;
}

div.progress_bar {
	height: 100%;
	background: #4bd472;
}
</style>
</head>
<body>
<h1>ちょうさ・ぶんせきマシン （仮）</h1>
<p>Lv50 1周目限定</p>
<p><input type="text" id="shuu_input" size="2" value="1"> 周目</p>
<form action="" name="entries_form" onsubmit="return false;">
<p>6匹のポケモンと親IDで入力:</p>
<table><tr>
<td style="vertical-align:top">
<textarea cols="30" rows="6" id="entries">
マイナン　11067
パチリス　63599
ムクバード　62326
ハスブレロ　27843
パッチール　50041
カラナクシ　10484</textarea><br>
<input type="submit" name="entries_submit" value="決定">
<td style="vertical-align:top;width:14em">
<small>
全角・半角・ひらがな・カタカナは問いません。<br>
「pikachuu」のようにローマ字のままでもOKです。<br>
ボーナスポケモンは「○○○&nbsp;12345&nbsp;b」のように後ろにbをつけてください
</small>
</tr></table>
</form>
<form action="" name="seed_form" onsubmit="return false;">
<p>seed+消費量で入力: <input type="text" name="seed" size="15" value="0x00000000">+<input type="text" name="consumption" size="6" value="0"> ボーナスポケ: <input type="text" name="num_bonus" size="3" value="0"> 匹 <input type="submit" name="seed_submit" value="決定"></p>
</form>
<div id="result"></div>
</body>
</html>
